# 医学宝典 - 环境变量配置示例
# 复制此文件为 .env.local 并填写实际配置
#
# 配置验证说明：
# - 应用启动时会自动验证所有必需的环境变量
# - 缺少或无效的配置会导致应用启动失败并显示详细错误信息
# - 查看错误信息中的"💡"部分获取修复建议

# ==================== 应用配置 ====================
# 运行环境：development, production, test
# Required: No
# Default: development
# Validation: 必须是 development, production, test 之一
NODE_ENV=development

# 服务端口
# Required: No
# Default: 3000
# Validation: 1-65535 之间的整数
PORT=3000

# ==================== 文件上传配置 ====================
# 上传文件存储根目录
# 安全警告：生产环境必须将此目录设置在应用代码目录之外
# - 开发环境：可以使用相对路径 ./uploads
# - 生产环境：必须使用绝对路径，例如 /var/uploads/medical-bible
# - 原因：防止用户上传的文件与应用代码混合，提高安全性
# - 注意：确保此目录对应用进程有读写权限
UPLOAD_ROOT=./uploads

# 文件大小限制（字节，默认 50MB）
UPLOAD_MAX_SIZE=52428800

# 严格模式：验证 MIME 类型与文件扩展名匹配（默认 true）
UPLOAD_STRICT_MODE=true

# ==================== 病毒扫描配置 (SEC-008) ====================
# 是否启用病毒扫描（需要 ClamAV 服务）
UPLOAD_VIRUS_SCAN_ENABLED=false

# 病毒扫描提供商（clamav | cloud | disabled）
UPLOAD_VIRUS_SCAN_PROVIDER=clamav

# ClamAV 服务配置
UPLOAD_VIRUS_SCAN_CLAMAV_HOST=localhost
UPLOAD_VIRUS_SCAN_CLAMAV_PORT=3310
# Unix Socket 路径（优先使用，如果配置则忽略 TCP 连接）
# UPLOAD_VIRUS_SCAN_CLAMAV_SOCKET=/var/run/clamav/clamd.ctl

# 病毒扫描超时时间（毫秒）
UPLOAD_VIRUS_SCAN_TIMEOUT=30000

# 最大可扫描文件大小（字节，默认 100MB）
UPLOAD_VIRUS_SCAN_MAX_FILE_SIZE=104857600

# Fail-open 模式：扫描失败时是否允许通过（默认 true）
# - true: 扫描服务不可用时仍允许上传（适合非关键场景）
# - false: 扫描服务不可用时拒绝上传（适合高安全要求场景）
UPLOAD_VIRUS_SCAN_FAIL_OPEN=true

# ==================== CORS 跨域配置 ====================
# 允许的跨域源地址
# Required: No (开发环境有默认值)
# Default (dev): http://localhost:5173, http://localhost:3000
# Default (prod): false (拒绝所有请求)
# Validation: 逗号分隔的URL列表，生产环境不能使用 "*"
# 格式: "https://domain1.com,https://domain2.com"
# Security: 生产环境使用 "*" 通配符会导致启动失败
CORS_ORIGIN=http://localhost:5173

# ==================== 数据库配置 ====================
# 数据库主机地址
# Required: No
# Default: localhost
DB_HOST=localhost

# 数据库端口
# Required: No
# Default: 3306
# Validation: 1-65535 之间的整数
DB_PORT=3306

# 数据库用户名
# Required: No
# Default: root
DB_USERNAME=root

# 数据库密码
# Required: No
# Default: (空字符串)
DB_PASSWORD=your_password_here

# 数据库名称
# Required: No
# Default: medical_bible
DB_DATABASE=medical_bible

# 数据库连接池配置
# 连接池最大连接数（默认: 20）
# 生产环境建议: 根据并发量和数据库性能调整，通常为 (CPU核心数 * 2) + 磁盘数
DB_POOL_MAX=20
# 连接池最小连接数（默认: 5）
# 建议设置为 DB_POOL_MAX 的 20-30%
DB_POOL_MIN=5
# 获取连接的超时时间，单位: 毫秒（默认: 30000）
DB_POOL_ACQUIRE_TIMEOUT=30000
# 连接空闲超时时间，单位: 毫秒（默认: 300000，即5分钟）
# 空闲超过此时长的连接将被释放
DB_POOL_IDLE_TIMEOUT=300000
# 连接最大生命周期，单位: 毫秒（默认: 1800000，即30分钟）
# 连接超过此时长将被关闭并重建
DB_POOL_MAX_LIFETIME=1800000
# 连接超时时间，单位: 毫秒（默认: 60000，即1分钟）
DB_CONNECTION_TIMEOUT=60000
# 查询超时时间，单位: 毫秒（默认: 60000，即1分钟）
DB_QUERY_TIMEOUT=60000

# ==================== Redis 配置 ====================
# Redis 主机地址
# Required: No
# Default: localhost
REDIS_HOST=localhost

# Redis 端口
# Required: No
# Default: 6379
# Validation: 1-65535 之间的整数
REDIS_PORT=6379

# Redis 密码
# Required: No
# Default: (无密码)
REDIS_PASSWORD=

# Redis 数据库索引
# Required: No
# Default: 0
# Validation: 0-15 之间的整数
REDIS_DB=0

# ==================== JWT 配置 ====================
# Access Token 签名密钥
# Required: Yes (所有环境)
# Validation: 字符串，最少32个字符
# Security: 必须设置强随机密钥，应用启动时会验证
JWT_SECRET=your_jwt_secret_here_please_change_it_minimum_32_chars

# Access Token 过期时间
# Required: No
# Default: 15m
# Example: 15m, 1h, 7d
JWT_ACCESS_EXPIRES=15m

# Refresh Token 签名密钥
# Required: No (如果未设置，使用 JWT_SECRET)
# Validation: 字符串，最少32个字符
# Security: 建议使用不同于 JWT_SECRET 的独立密钥以提高安全性
JWT_REFRESH_SECRET=your_jwt_refresh_secret_here_different_from_access_min_32

# Refresh Token 过期时间
# Required: No
# Default: 7d
# Example: 7d, 30d
JWT_REFRESH_EXPIRES=7d

# ==================== 压缩配置 ====================
# 是否启用 HTTP 响应压缩
# Required: No
# Default: true
# Validation: "true" 或 "false"
COMPRESSION_ENABLED=true

# 压缩级别 (1=最快, 6=平衡, 9=最高压缩率)
# Required: No
# Default: 6
# Validation: 1, 6, 或 9
COMPRESSION_LEVEL=6

# 压缩阈值（字节），小于此大小的响应不压缩
# Required: No
# Default: 1024
# Validation: 非负整数
COMPRESSION_THRESHOLD=1024

# ==================== 限流配置 ====================
# 是否启用限流
# Required: No
# Default: true
# Validation: "true" 或 "false"
RATE_LIMIT_ENABLED=true

# 全局限流配置（所有请求的总体限流）
# Required: No
# Default: MAX=1000, WINDOW=60
RATE_LIMIT_GLOBAL_MAX=1000
RATE_LIMIT_GLOBAL_WINDOW=60

# 认证端点限流配置（登录、刷新令牌等）
# Required: No
# Default: MAX=10, WINDOW=3600
RATE_LIMIT_AUTH_MAX=10
RATE_LIMIT_AUTH_WINDOW=3600

# 普通端点限流配置
# Required: No
# Default: MAX=30, WINDOW=60
RATE_LIMIT_STANDARD_MAX=30
RATE_LIMIT_STANDARD_WINDOW=60

# 验证码端点限流配置
# Required: No
# Default: MAX=10, WINDOW=86400
RATE_LIMIT_VERIFICATION_MAX=10
RATE_LIMIT_VERIFICATION_WINDOW=86400

# 严格端点限流配置（注册、重置密码等）
# Required: No
# Default: MAX=5, WINDOW=60
RATE_LIMIT_STRICT_MAX=5
RATE_LIMIT_STRICT_WINDOW=60

# 宽松端点限流配置
# Required: No
# Default: MAX=100, WINDOW=60
RATE_LIMIT_RELAXED_MAX=100
RATE_LIMIT_RELAXED_WINDOW=60

# 限流键前缀
# Required: No
# Default: rate_limit
RATE_LIMIT_KEY_PREFIX=rate_limit

# Redis 不可用时是否跳过限流检查
# Required: No
# Default: false
# Validation: "true" 或 "false"
# Recommendation: 生产环境建议设为 false
RATE_LIMIT_SKIP_ON_REDIS_ERROR=false

# ==================== 日志配置 ====================
# 日志级别
# Required: No
# Default: development=debug, production=info
# Validation: fatal, error, warn, info, debug, trace, silent
LOG_LEVEL=info

# 日志目录
# Required: No
# Default: logs
LOG_DIR=logs

# 日志文件最大大小
# Required: No
# Default: 100M
# Example: 100M, 1G
LOG_MAX_SIZE=100M

# 日志文件保留数量
# Required: No
# Default: 10
# Validation: 正整数
LOG_MAX_FILES=10

# 日志文件保留天数
# Required: No
# Default: 30
# Validation: 正整数
LOG_RETENTION_DAYS=30

# ==================== 安全头配置 ====================
# 安全头中间件开关（默认启用）
SECURITY_ENABLED=true

# HSTS (HTTP Strict Transport Security) - 强制 HTTPS
# 仅在生产环境启用（需要 HTTPS）
HSTS_ENABLED=true
HSTS_MAX_AGE=31536000
HSTS_INCLUDE_SUB_DOMAINS=true
HSTS_PRELOAD=false

# CSP (Content Security Policy) - 内容安全策略
# 防止 XSS 攻击，控制资源加载来源
CSP_ENABLED=true
CSP_DEFAULT_SRC='self'
CSP_SCRIPT_SRC='self'
CSP_STYLE_SRC='self','unsafe-inline'
CSP_IMG_SRC='self','data:','https:'
CSP_CONNECT_SRC='self'
CSP_FONT_SRC='self'
CSP_OBJECT_SRC='none'
CSP_MEDIA_SRC='self'
CSP_FRAME_SRC='none'
CSP_WORKER_SRC='self'
CSP_BASE_URI='self'
CSP_FORM_ACTION='self'
CSP_FRAME_ANCESTORS='none'
CSP_UPGRADE_INSECURE=true

# X-Frame-Options (已弃用，建议使用 CSP frame-ancestors)
X_FRAME_OPTIONS=DENY

# Referrer-Policy
REFERRER_POLICY=strict-origin-when-cross-origin

# 跨域策略（默认禁用，按需启用）
CROSS_ORIGIN_EMBEDDER_POLICY=false
CROSS_ORIGIN_RESOURCE_POLICY=false

# ==================== WebSocket 配置 ====================
# 每个用户最大同时连接数
# Required: No
# Default: 3
# Validation: 正整数
WS_MAX_CONNECTIONS_PER_USER=3

# 连接心跳间隔（毫秒）
# Required: No
# Default: 25000
# Validation: 正整数
WS_HEARTBEAT_INTERVAL=25000

# 连接超时时间（毫秒）
# Required: No
# Default: 60000
# Validation: 正整数
WS_CONNECTION_TIMEOUT=60000

# 消息队列过期时间（秒）
# Required: No
# Default: 604800 (7天)
# Validation: 正整数
WS_MESSAGE_QUEUE_TTL=604800

# 重连延迟初始值（毫秒）
# Required: No
# Default: 1000
# Validation: 正整数
WS_RECONNECT_DELAY_MIN=1000

# 重连延迟最大值（毫秒）
# Required: No
# Default: 30000
# Validation: 正整数
WS_RECONNECT_DELAY_MAX=30000

# 重连尝试次数限制
# Required: No
# Default: 10
# Validation: 正整数
WS_MAX_RECONNECT_ATTEMPTS=10

# ==================== 阿里云 OSS 配置 ====================
# OSS 访问密钥 ID
OSS_ACCESS_KEY_ID=your_access_key_id

# OSS 访问密钥 Secret
OSS_ACCESS_KEY_SECRET=your_access_key_secret

# OSS 存储桶名称
OSS_BUCKET=medical-bible

# OSS 区域
OSS_REGION=oss-cn-beijing

# OSS 端点
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com

# ==================== 加密密钥 ====================
# 用于加密敏感配置（如支付密钥）
# Required: No (但强烈建议在生产环境设置)
# Validation: 字符串
# Security: 生产环境必须设置此值，否则使用不安全的默认密钥
ENCRYPTION_KEY=your_random_encryption_key_at_least_32_chars

# ==================== Cookie 安全配置 ====================
# 是否启用 Cookie 安全配置
# Required: No
# Default: true
# Validation: "true" 或 "false"
COOKIE_SECURITY_ENABLED=true

# Cookie Secure 属性 - 仅 HTTPS 传输
# Required: No
# Default (dev): false
# Default (prod): true
# Validation: "true" 或 "false"
# Security: 生产环境强烈建议启用
COOKIE_SECURE=false

# Cookie HttpOnly 属性 - 防止 JavaScript 访问（防止 XSS 攻击）
# Required: No
# Default: true
# Validation: "true" 或 "false"
# Security: 建议始终保持启用
COOKIE_HTTP_ONLY=true

# Cookie SameSite 属性 - 防止 CSRF 攻击
# Required: No
# Default (dev): lax
# Default (prod): strict
# Validation: strict, lax, none
# Security: SameSite=none 必须与 secure=true 同时使用
COOKIE_SAME_SITE=lax

# Cookie 作用域域名
# Required: No
# Default: (当前域名)
# Example: .example.com (用于子域名共享)
COOKIE_DOMAIN=

# Cookie 路径
# Required: No
# Default: /
COOKIE_PATH=/

# Cookie 过期时间（毫秒）
# Required: No
# Default: (会话 Cookie，浏览器关闭时失效)
# Example: 604800000 (7天)
COOKIE_MAX_AGE=

# Cookie 签名（用于防止篡改）
# Required: No
# Default: false
# Validation: "true" 或 "false"
COOKIE_SIGNED=false

# 是否覆盖同名 Cookie
# Required: No
# Default: true
# Validation: "true" 或 "false"
COOKIE_OVERWRITE=true

# ==================== 审计日志配置 ====================
# 是否启用审计日志
# Required: No
# Default: true
# Validation: true/false
# Compliance: 生产环境应始终保持启用，以满足医疗合规要求（HIPAA/GDPR）
AUDIT_ENABLED=true

# 审计日志保留天数（默认：2555天 = 7年，符合HIPAA要求）
# Required: No
# Default: 2555
# Validation: 正整数
# Compliance: HIPAA要求保留至少6年，GDPR要求根据具体情况保留
AUDIT_RETENTION_DAYS=2555

# 审计日志导出目录
# Required: No
# Default: uploads/audit_exports
# Validation: 文件系统路径
AUDIT_EXPORT_DIR=uploads/audit_exports

# 哈希算法（用于完整性验证）
# Required: No
# Default: sha256
# Validation: 支持的哈希算法（sha256, sha512等）
AUDIT_HASH_ALGORITHM=sha256

# 审计日志完整性检查间隔（小时）
# Required: No
# Default: 24
# Validation: 正整数
AUDIT_INTEGRITY_CHECK_HOURS=24

# 单次导出最大记录数
# Required: No
# Default: 100000
# Validation: 正整数
AUDIT_MAX_EXPORT_RECORDS=100000

# 导出文件过期天数
# Required: No
# Default: 7
# Validation: 正整数
AUDIT_EXPORT_EXPIRY_DAYS=7

# ==================== APM 性能监控配置 ====================
# 应用性能监控（基于 OpenTelemetry）
# APM_ENABLED: 是否启用 APM（默认 true）
APM_ENABLED=true

# APM_SERVICE_NAME: 服务名称（用于追踪和指标识别）
APM_SERVICE_NAME=medical-bible-api

# APM_SERVICE_VERSION: 服务版本
APM_SERVICE_VERSION=1.0.0

# APM_ENVIRONMENT: 部署环境（development/production）
APM_ENVIRONMENT=development

# APM_SERVICE_TYPE: APM 后端服务类型
# 可选值: console（控制台）, otlp（OpenTelemetry 协议）, jaeger, zipkin, datadog, new_relic
# 开发环境默认 console，生产环境建议使用 otlp
APM_SERVICE_TYPE=console

# APM_OTLP_ENDPOINT: OTLP 导出端点（用于 OTLP/Jaeger/Zipkin）
# 默认: http://localhost:4317
APM_OTLP_ENDPOINT=http://localhost:4317

# APM_OTLP_HEADERS: OTLP 认证头部（JSON 格式）
# 示例: {"Authorization": "Bearer token123"}
# APM_OTLP_HEADERS={"Authorization": "Bearer your_token"}

# APM_SAMPLE_RATE: 采样率（0-1）
# 开发环境建议 1.0（全采样），生产环境建议 0.1-0.3（减少开销）
APM_SAMPLE_RATE=1.0

# APM_TRACING_ENABLED: 是否启用分布式追踪
APM_TRACING_ENABLED=true

# APM_METRICS_ENABLED: 是否启用指标收集
APM_METRICS_ENABLED=true

# APM_METRICS_EXPORT_INTERVAL: 指标导出间隔（毫秒）
# 默认: 30000（30秒）
APM_METRICS_EXPORT_INTERVAL=30000

# APM_DB_QUERY_THRESHOLD: 慢查询阈值（毫秒）
# 超过此值的查询会被记录为慢查询
APM_DB_QUERY_THRESHOLD=1000

# APM_HTTP_REQUEST_THRESHOLD: 慢请求阈值（毫秒）
# 超过此值的请求会被记录为慢请求
APM_HTTP_REQUEST_THRESHOLD=3000

# APM_REDIS_COMMAND_THRESHOLD: 慢 Redis 命令阈值（毫秒）
APM_REDIS_COMMAND_THRESHOLD=500

# APM_ALERTS_ENABLED: 是否启用告警
APM_ALERTS_ENABLED=false

# APM_ALERT_WEBHOOK_URL: 告警 Webhook URL
# 收到告警时会发送 POST 请求到此 URL
# APM_ALERT_WEBHOOK_URL=https://your-webhook-url.com/alerts

# APM_ALERT_THROTTLE_INTERVAL: 告警限流间隔（秒）
# 防止告警风暴，默认 300 秒
APM_ALERT_THROTTLE_INTERVAL=300

# APM_ADDITIONAL_LABELS: 额外的资源标签（JSON 格式）
# 示例: {"team": "backend", "region": "cn-beijing"}
# APM_ADDITIONAL_LABELS={"team": "backend"}
# ==================== 以下配置已迁移到数据库管理 ====================
# 短信、邮件、支付等配置现在通过后台管理界面配置
# 存储在 system_configs 表中，敏感信息会自动加密

# ==================== 健康检查配置 ====================
# 健康检查超时时间，单位: 毫秒（默认: 3000）
HEALTH_CHECK_TIMEOUT=3000
# 健康检查重试次数（默认: 3）
HEALTH_CHECK_RETRIES=3
# 数据库健康检查开关（默认: true）
HEALTH_CHECK_DATABASE=true
# Redis 健康检查开关（默认: true）
HEALTH_CHECK_REDIS=true
# 存储服务健康检查开关（默认: false，需要外部存储时启用）
HEALTH_CHECK_STORAGE=false
# 邮件服务健康检查开关（默认: false，需要时启用）
HEALTH_CHECK_EMAIL=false
# 短信服务健康检查开关（默认: false，需要时启用）
HEALTH_CHECK_SMS=false
