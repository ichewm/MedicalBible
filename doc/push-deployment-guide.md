# Push-based Deployment / æ¨é€å¼éƒ¨ç½²æŒ‡å—

> **æ ¸å¿ƒç‰¹ç‚¹**ï¼šGitHub ä¸»åŠ¨æ¨é€ä»£ç åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å®Œå…¨è¢«åŠ¨ï¼Œæ— éœ€è®¿é—®ä»»ä½•å¤–éƒ¨ç½‘ç»œ

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           GitHub Actions                                  â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä»£ç å˜æ›´ â”‚â”€â”€â”€â–¶â”‚ è¿è¡Œæµ‹è¯•    â”‚â”€â”€â”€â–¶â”‚ æ‰“åŒ…ä»£ç     â”‚â”€â”€â”€â–¶â”‚ SSH æ¨é€    â”‚  â”‚
â”‚  â”‚ (trigger)â”‚    â”‚ (test)      â”‚    â”‚ (package)   â”‚    â”‚ (deploy)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â”‚ Secrets: SSH_KEY, DB_PASSWORD, JWT_SECRET...                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                  â”‚
                                                    SSH + SCP     â”‚ ä¸»åŠ¨æ¨é€
                                                    (22ç«¯å£)      â”‚
                                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å›½å†…æœåŠ¡å™¨                                      â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ æ¥æ”¶ä»£ç åŒ…   â”‚â”€â”€â”€â–¶â”‚ è§£å‹éƒ¨ç½²    â”‚â”€â”€â”€â–¶â”‚ å¯åŠ¨æœåŠ¡    â”‚                   â”‚
â”‚  â”‚ (passive)   â”‚    â”‚ (extract)   â”‚    â”‚ (docker)    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                           â”‚
â”‚  ğŸ”’ æœåŠ¡å™¨ä¸éœ€è¦ï¼š                                                         â”‚
â”‚     âŒ è®¿é—® GitHub                                                        â”‚
â”‚     âŒ å­˜å‚¨ GitHub Token                                                  â”‚
â”‚     âŒ æ‰§è¡Œ git pull/clone                                                â”‚
â”‚     âŒ é•¿æœŸå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆæ¯æ¬¡éƒ¨ç½²æ—¶ç”± GitHub æ³¨å…¥ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1ï¸âƒ£ åˆå§‹åŒ–æœåŠ¡å™¨

SSH ç™»å½•åˆ°ä½ çš„å›½å†…æœåŠ¡å™¨ï¼Œæ‰§è¡Œï¼š

```bash
# ä¸‹è½½å¹¶æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
curl -sSL https://raw.githubusercontent.com/YOUR_ORG/MedicalBible/main/scripts/init-china-server.sh -o init.sh

# æˆ–è€…ï¼šç›´æ¥å¤åˆ¶ scripts/init-china-server.sh å†…å®¹åˆ°æœåŠ¡å™¨æ‰§è¡Œ

# æ‰§è¡Œåˆå§‹åŒ–
sudo bash init.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
- âœ… é…ç½®å›½å†…é•œåƒæºï¼ˆé˜¿é‡Œäº‘ï¼‰
- âœ… å®‰è£… Dockerï¼ˆé˜¿é‡Œäº‘æºï¼‰
- âœ… é…ç½® Docker é•œåƒåŠ é€Ÿ
- âœ… åˆ›å»º `deploy` éƒ¨ç½²ç”¨æˆ·
- âœ… ç”Ÿæˆ SSH å¯†é’¥å¯¹
- âœ… é…ç½®é˜²ç«å¢™è§„åˆ™

### 2ï¸âƒ£ é…ç½® GitHub Secrets

åœ¨ GitHub ä»“åº“è®¾ç½® **Settings â†’ Secrets and variables â†’ Actions**ï¼š

| Secret åç§° | è¯´æ˜ | ç¤ºä¾‹ |
|------------|------|------|
| **å¿…éœ€** | | |
| `SERVER_HOST` | æœåŠ¡å™¨ IP æˆ–åŸŸå | `123.45.67.89` |
| `SERVER_USER` | éƒ¨ç½²ç”¨æˆ· | `deploy` |
| `SERVER_SSH_KEY` | SSH ç§é’¥ï¼ˆåˆå§‹åŒ–è„šæœ¬è¾“å‡ºï¼‰ | `-----BEGIN OPENSSH PRIVATE KEY-----...` |
| `SERVER_PORT` | SSH ç«¯å£ | `22` |
| `DB_ROOT_PASSWORD` | MySQL root å¯†ç  | `your-strong-password` |
| `REDIS_PASSWORD` | Redis å¯†ç  | `your-redis-password` |
| `JWT_SECRET` | JWT ç­¾åå¯†é’¥ | `your-jwt-secret-key` |
| `ENCRYPTION_KEY` | æ•°æ®åŠ å¯†å¯†é’¥ | `your-encryption-key` |
| **å¯é€‰** | | |
| `HEALTH_CHECK_URL` | å¥åº·æ£€æŸ¥åœ°å€ | `https://your-domain.com/api/v1/health` |
| `CORS_ORIGIN` | CORS å…è®¸åŸŸå | `https://your-domain.com` |
| `ALIYUN_ACCESS_KEY_ID` | é˜¿é‡Œäº‘ AK | |
| `ALIYUN_ACCESS_KEY_SECRET` | é˜¿é‡Œäº‘ SK | |
| `WECHAT_APP_ID` | å¾®ä¿¡ AppID | |
| `WECHAT_MCH_ID` | å¾®ä¿¡å•†æˆ·å· | |

### 3ï¸âƒ£ è§¦å‘éƒ¨ç½²

#### æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰

1. è¿›å…¥ GitHub ä»“åº“ â†’ **Actions** é¡µç­¾
2. é€‰æ‹© **Push Deploy to China Server**
3. ç‚¹å‡» **Run workflow**
4. é€‰æ‹©å‚æ•°ï¼š
   - `environment`: production
   - `deploy_type`: full / backend / frontend / config
   - `backup_db`: æ˜¯å¦å¤‡ä»½æ•°æ®åº“
   - `skip_tests`: æ˜¯å¦è·³è¿‡æµ‹è¯•

#### æ–¹å¼äºŒï¼šå‘å¸ƒ Release è‡ªåŠ¨è§¦å‘

åˆ›å»ºæ–°çš„ Release æ—¶è‡ªåŠ¨éƒ¨ç½²ã€‚

## éƒ¨ç½²ç±»å‹è¯´æ˜

| ç±»å‹ | æè¿° | å½±å“ |
|------|------|------|
| `full` | å®Œæ•´éƒ¨ç½² | å‰ç«¯ + åç«¯ + é…ç½®å…¨éƒ¨æ›´æ–° |
| `backend` | ä»…åç«¯ | åªé‡å»ºåç«¯å®¹å™¨ |
| `frontend` | ä»…å‰ç«¯ | åªé‡å»ºå‰ç«¯å®¹å™¨ |
| `config` | ä»…é…ç½® | æ›´æ–°é…ç½®æ–‡ä»¶ï¼Œé‡å¯å®¹å™¨ |

## æ•°æ®å®‰å…¨

### æ•æ„Ÿä¿¡æ¯ç®¡ç†

```
GitHub Secrets (åŠ å¯†å­˜å‚¨)
        â”‚
        â”‚ éƒ¨ç½²æ—¶åŠ¨æ€æ³¨å…¥
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡å™¨ .env æ–‡ä»¶                        â”‚
â”‚  (æ¯æ¬¡éƒ¨ç½²æ—¶è¦†ç›–ï¼Œæƒé™ 600)              â”‚
â”‚                                          â”‚
â”‚  DB_ROOT_PASSWORD=***                    â”‚
â”‚  REDIS_PASSWORD=***                      â”‚
â”‚  JWT_SECRET=***                          â”‚
â”‚  ...                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- âœ… æ•æ„Ÿä¿¡æ¯åªåœ¨ GitHub Secrets ä¸­å­˜å‚¨
- âœ… éƒ¨ç½²æ—¶åŠ¨æ€ç”Ÿæˆ `.env` æ–‡ä»¶æ¨é€åˆ°æœåŠ¡å™¨
- âœ… `.env` æ–‡ä»¶æƒé™è®¾ä¸º 600ï¼Œä»… deploy ç”¨æˆ·å¯è¯»
- âœ… æ—¥å¿—ä¸­ä¸ä¼šæ˜¾ç¤ºä»»ä½•æ•æ„Ÿä¿¡æ¯

### æ•°æ®åº“å¤‡ä»½

éƒ¨ç½²å‰å¯é€‰æ‹©è‡ªåŠ¨å¤‡ä»½ï¼š

```bash
# å¤‡ä»½å­˜å‚¨ä½ç½®
/opt/medical-bible/backups/
â”œâ”€â”€ pre_deploy_20241209_120000.sql.gz
â”œâ”€â”€ pre_deploy_20241208_100000.sql.gz
â””â”€â”€ ...
```

æ‰‹åŠ¨å¤‡ä»½ï¼š
```bash
# SSH åˆ°æœåŠ¡å™¨
cd /opt/medical-bible
docker compose -f docker-compose.prod.yml exec mysql mysqldump \
  -u root -p"$DB_ROOT_PASSWORD" \
  --single-transaction medical_bible | gzip > backups/manual_backup.sql.gz
```

æ¢å¤æ•°æ®ï¼š
```bash
# è§£å‹å¹¶æ¢å¤
gunzip -c backups/manual_backup.sql.gz | \
  docker compose -f docker-compose.prod.yml exec -T mysql mysql \
  -u root -p"$DB_ROOT_PASSWORD" medical_bible
```

## æ•…éšœæ’æŸ¥

### æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—

```bash
# SSH åˆ°æœåŠ¡å™¨
cd /opt/medical-bible

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹åç«¯æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f backend

# æŸ¥çœ‹å‰ç«¯æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f frontend

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f mysql
```

### å¸¸è§é—®é¢˜

#### Q: SSH è¿æ¥å¤±è´¥
```
# æ£€æŸ¥ SSH å¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®
cat /home/deploy/.ssh/authorized_keys

# æ£€æŸ¥ SSH æœåŠ¡çŠ¶æ€
systemctl status sshd

# æ£€æŸ¥é˜²ç«å¢™
ufw status  # Ubuntu
firewall-cmd --list-all  # CentOS
```

#### Q: Docker é•œåƒæ‹‰å–æ…¢
```bash
# æ£€æŸ¥é•œåƒåŠ é€Ÿé…ç½®
cat /etc/docker/daemon.json

# æµ‹è¯•é•œåƒæ‹‰å–
docker pull nginx
```

#### Q: å®¹å™¨å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
docker compose -f docker-compose.prod.yml logs --tail=100 backend

# æ£€æŸ¥ .env æ–‡ä»¶
cat /opt/medical-bible/.env
```

#### Q: å¥åº·æ£€æŸ¥å¤±è´¥
```bash
# æ‰‹åŠ¨æ£€æŸ¥æœåŠ¡
curl http://localhost:3000/api/v1/health

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 3000
```

## å®‰å…¨æœ€ä½³å®è·µ

### æœåŠ¡å™¨å®‰å…¨

1. **ä¿®æ”¹ SSH ç«¯å£**
   ```bash
   # /etc/ssh/sshd_config
   Port 22222  # æ”¹ä¸ºéæ ‡å‡†ç«¯å£
   ```

2. **ç¦ç”¨å¯†ç ç™»å½•**
   ```bash
   # /etc/ssh/sshd_config
   PasswordAuthentication no
   ```

3. **é…ç½® fail2ban**
   ```bash
   apt install fail2ban
   ```

### GitHub Secrets å®‰å…¨

1. **å®šæœŸè½®æ¢å¯†é’¥**
   - æ¯ 3-6 ä¸ªæœˆæ›´æ¢ SSH å¯†é’¥
   - æ›´æ¢åæ›´æ–° GitHub Secrets å’ŒæœåŠ¡å™¨ authorized_keys

2. **æœ€å°æƒé™åŸåˆ™**
   - deploy ç”¨æˆ·åªæœ‰ docker ç›¸å…³æƒé™
   - ä¸è¦ä½¿ç”¨ root ç”¨æˆ·éƒ¨ç½²

3. **ç¯å¢ƒéš”ç¦»**
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç‹¬ç«‹çš„ Secrets
   - å¯åˆ›å»º staging ç¯å¢ƒç”¨äºæµ‹è¯•

## ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æœåŠ¡å™¨æ˜¯å¦éœ€è®¿é—® GitHub | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|------------------------|--------|----------|
| **Push-basedï¼ˆæœ¬æ–¹æ¡ˆï¼‰** | âŒ ä¸éœ€è¦ | ä¸­ | å›½å†…æœåŠ¡å™¨ã€ç½‘ç»œå—é™ |
| Self-hosted Runner | âŒ ä¸éœ€è¦ | é«˜ | ä¼ä¸šå†…ç½‘ã€é«˜å®‰å…¨è¦æ±‚ |
| Webhook + git pull | âœ… éœ€è¦ | ä½ | æµ·å¤–æœåŠ¡å™¨ |
| ArgoCD / GitOps | âœ… éœ€è¦ | é«˜ | K8s é›†ç¾¤ |

## ç›®å½•ç»“æ„

```
.github/workflows/
â”œâ”€â”€ ci.yml              # æŒç»­é›†æˆï¼ˆæµ‹è¯•ã€æ„å»ºï¼‰
â”œâ”€â”€ cd.yml              # æ„å»º Docker é•œåƒ
â””â”€â”€ push-deploy.yml     # æ¨é€å¼éƒ¨ç½²ï¼ˆæœ¬æ–¹æ¡ˆï¼‰

scripts/
â”œâ”€â”€ init-china-server.sh  # æœåŠ¡å™¨åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ backup-db.sh          # æ•°æ®åº“å¤‡ä»½
â””â”€â”€ restore-db.sh         # æ•°æ®åº“æ¢å¤
```
